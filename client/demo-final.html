<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo Final - Sistema de Autenticaci√≥n</title>
    <link rel="stylesheet" href="css/login.css" />
    <style>
      .demo-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
      }
      .demo-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: white;
      }
      .step {
        margin: 15px 0;
        padding: 15px;
        border-left: 4px solid #667eea;
        background: #f8f9fa;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <h1>üéâ Demo Final - Sistema de Autenticaci√≥n MinCRM</h1>

      <div class="demo-section">
        <h2>üìã Resumen del Sistema Implementado</h2>
        <div class="demo-grid">
          <div>
            <h3>Backend (Node.js + Express)</h3>
            <ul>
              <li>‚úÖ Modelo User con Mongoose</li>
              <li>‚úÖ Hash de contrase√±as con bcrypt</li>
              <li>‚úÖ JWT para autenticaci√≥n</li>
              <li>‚úÖ Middleware de protecci√≥n</li>
              <li>‚úÖ Rutas protegidas</li>
            </ul>
          </div>
          <div>
            <h3>Frontend (JavaScript Vanilla)</h3>
            <ul>
              <li>‚úÖ Formularios de login y registro</li>
              <li>‚úÖ Validaciones en tiempo real</li>
              <li>‚úÖ localStorage para tokens</li>
              <li>‚úÖ Protecci√≥n de rutas</li>
              <li>‚úÖ Manejo de errores</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>üîß Pruebas del Sistema</h2>

        <div class="step">
          <h3>Paso 1: Verificar Conectividad</h3>
          <button onclick="testConnection()">
            Probar Conexi√≥n al Servidor
          </button>
          <div id="connectionResult" class="result"></div>
        </div>

        <div class="step">
          <h3>Paso 2: Probar Flujo Completo</h3>
          <button onclick="testCompleteFlow()">Ejecutar Flujo Completo</button>
          <div id="flowResult" class="result"></div>
        </div>

        <div class="step">
          <h3>Paso 3: Probar Rutas Protegidas</h3>
          <button onclick="testProtectedRoutes()">
            Probar Contactos y Tareas
          </button>
          <div id="protectedResult" class="result"></div>
        </div>

        <div class="step">
          <h3>Paso 4: Probar Seguridad</h3>
          <button onclick="testSecurity()">
            Probar Protecci√≥n con Token Inv√°lido
          </button>
          <div id="securityResult" class="result"></div>
        </div>
      </div>

      <div class="demo-section">
        <h2>üåê P√°ginas del Sistema</h2>
        <div class="demo-grid">
          <div>
            <h3>P√°ginas P√∫blicas</h3>
            <a href="index.html" target="_blank">üè† P√°gina Principal</a><br />
            <a href="login.html" target="_blank">üîë Login</a><br />
            <a href="register.html" target="_blank">üìù Registro</a>
          </div>
          <div>
            <h3>P√°ginas Protegidas</h3>
            <a href="dashboard.html" target="_blank">üìä Dashboard</a><br />
            <a href="contacts.html" target="_blank">üë• Contactos</a><br />
            <a href="tasks.html" target="_blank">üìã Tareas</a>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>üìä Estado del Sistema</h2>
        <div id="systemStatus">
          <p>Cargando estado del sistema...</p>
        </div>
        <button onclick="checkSystemStatus()">Actualizar Estado</button>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3000";
      let demoToken = null;

      async function testConnection() {
        const resultDiv = document.getElementById("connectionResult");
        resultDiv.innerHTML = "<p>üîÑ Probando conexi√≥n...</p>";

        try {
          const response = await fetch(`${API_BASE_URL}/`);
          const data = await response.json();

          resultDiv.innerHTML = `
                    <div style="color: green;">
                        ‚úÖ Conexi√≥n exitosa al servidor<br>
                        <strong>Mensaje:</strong> ${data.message}<br>
                        <strong>Versi√≥n:</strong> ${data.version}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error de conexi√≥n: ${error.message}
                    </div>
                `;
        }
      }

      async function testCompleteFlow() {
        const resultDiv = document.getElementById("flowResult");
        resultDiv.innerHTML = "<p>üîÑ Ejecutando flujo completo...</p>";

        const testUser = {
          name: "Demo User",
          email: `demo${Date.now()}@example.com`,
          password: "123456",
        };

        try {
          let steps = [];

          // Paso 1: Registro
          steps.push("1Ô∏è‚É£ Registrando usuario...");
          const registerResponse = await fetch(
            `${API_BASE_URL}/api/auth/register`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(testUser),
            }
          );
          const registerData = await registerResponse.json();

          if (registerData.success) {
            steps.push("‚úÖ Registro exitoso");
            demoToken = registerData.data.token;

            // Paso 2: Login
            steps.push("2Ô∏è‚É£ Haciendo login...");
            const loginResponse = await fetch(
              `${API_BASE_URL}/api/auth/login`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: testUser.email,
                  password: testUser.password,
                }),
              }
            );
            const loginData = await loginResponse.json();

            if (loginData.success) {
              steps.push("‚úÖ Login exitoso");
              demoToken = loginData.data.token;

              // Paso 3: Perfil
              steps.push("3Ô∏è‚É£ Obteniendo perfil...");
              const profileResponse = await fetch(
                `${API_BASE_URL}/api/auth/profile`,
                {
                  headers: { Authorization: `Bearer ${demoToken}` },
                }
              );
              const profileData = await profileResponse.json();

              if (profileData.success) {
                steps.push("‚úÖ Perfil obtenido correctamente");
                steps.push(`üë§ Usuario: ${profileData.data.user.name}`);
                steps.push("üéâ FLUJO COMPLETO EXITOSO");

                resultDiv.innerHTML = `
                                <div style="color: green;">
                                    ${steps
                                      .map((step) => `<div>${step}</div>`)
                                      .join("")}
                                </div>
                            `;
              } else {
                throw new Error("Error al obtener perfil");
              }
            } else {
              throw new Error("Error en login");
            }
          } else {
            throw new Error("Error en registro");
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error en el flujo: ${error.message}
                    </div>
                `;
        }
      }

      async function testProtectedRoutes() {
        const resultDiv = document.getElementById("protectedResult");

        if (!demoToken) {
          resultDiv.innerHTML = `
                    <div style="color: orange;">
                        ‚ö†Ô∏è Primero ejecuta el flujo completo para obtener un token
                    </div>
                `;
          return;
        }

        resultDiv.innerHTML = "<p>üîÑ Probando rutas protegidas...</p>";

        try {
          let results = [];

          // Probar contactos
          const contactsResponse = await fetch(`${API_BASE_URL}/api/contacts`, {
            headers: { Authorization: `Bearer ${demoToken}` },
          });
          const contactsData = await contactsResponse.json();

          if (contactsData.success) {
            results.push("‚úÖ Ruta /api/contacts accesible");
            results.push(`üë§ Usuario autenticado: ${contactsData.data.user}`);
          }

          // Probar tareas
          const tasksResponse = await fetch(`${API_BASE_URL}/api/tasks`, {
            headers: { Authorization: `Bearer ${demoToken}` },
          });
          const tasksData = await tasksResponse.json();

          if (tasksData.success) {
            results.push("‚úÖ Ruta /api/tasks accesible");
            results.push(`üë§ Usuario autenticado: ${tasksData.data.user}`);
          }

          results.push("üîí TODAS LAS RUTAS PROTEGIDAS FUNCIONANDO");

          resultDiv.innerHTML = `
                    <div style="color: green;">
                        ${results
                          .map((result) => `<div>${result}</div>`)
                          .join("")}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error probando rutas protegidas: ${error.message}
                    </div>
                `;
        }
      }

      async function testSecurity() {
        const resultDiv = document.getElementById("securityResult");
        resultDiv.innerHTML = "<p>üîÑ Probando seguridad...</p>";

        try {
          let results = [];

          // Probar sin token
          const noTokenResponse = await fetch(
            `${API_BASE_URL}/api/auth/profile`
          );
          if (noTokenResponse.status === 401) {
            results.push("‚úÖ Acceso denegado sin token");
          }

          // Probar con token inv√°lido
          const invalidTokenResponse = await fetch(
            `${API_BASE_URL}/api/auth/profile`,
            {
              headers: { Authorization: "Bearer token-invalido-123" },
            }
          );
          if (invalidTokenResponse.status === 403) {
            results.push("‚úÖ Acceso denegado con token inv√°lido");
          }

          // Probar contactos sin token
          const contactsNoTokenResponse = await fetch(
            `${API_BASE_URL}/api/contacts`
          );
          if (contactsNoTokenResponse.status === 401) {
            results.push("‚úÖ Ruta /api/contacts protegida correctamente");
          }

          results.push("üõ°Ô∏è SISTEMA DE SEGURIDAD FUNCIONANDO");

          resultDiv.innerHTML = `
                    <div style="color: green;">
                        ${results
                          .map((result) => `<div>${result}</div>`)
                          .join("")}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error probando seguridad: ${error.message}
                    </div>
                `;
        }
      }

      async function checkSystemStatus() {
        const statusDiv = document.getElementById("systemStatus");
        statusDiv.innerHTML = "<p>üîÑ Verificando estado del sistema...</p>";

        try {
          const serverResponse = await fetch(`${API_BASE_URL}/`);
          const serverData = await serverResponse.json();

          const authToken = localStorage.getItem("authToken");

          statusDiv.innerHTML = `
                    <div>
                        <h4>üñ•Ô∏è Estado del Servidor</h4>
                        <p>‚úÖ Servidor: ${serverData.status}</p>
                        <p>üì° API: ${serverData.message}</p>
                        <p>üî¢ Versi√≥n: ${serverData.version}</p>
                        
                        <h4>üîê Estado de Autenticaci√≥n</h4>
                        <p>${
                          authToken
                            ? "‚úÖ Token en localStorage"
                            : "‚ùå No hay token guardado"
                        }</p>
                        <p>üîë Demo Token: ${
                          demoToken ? "Disponible" : "No disponible"
                        }</p>
                        
                        <h4>üìä Resumen</h4>
                        <p>üéØ Sistema completo: <strong>FUNCIONANDO</strong></p>
                        <p>üîí Seguridad: <strong>ACTIVA</strong></p>
                        <p>üåê Frontend-Backend: <strong>CONECTADOS</strong></p>
                    </div>
                `;
        } catch (error) {
          statusDiv.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error verificando el sistema: ${error.message}
                    </div>
                `;
        }
      }

      // Verificar estado inicial
      document.addEventListener("DOMContentLoaded", () => {
        checkSystemStatus();
      });
    </script>
  </body>
</html>
