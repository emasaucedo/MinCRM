<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Completo de Autenticaci√≥n</title>
    <link rel="stylesheet" href="css/login.css" />
    <style>
      .test-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .console-output {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>Test Completo del Sistema de Autenticaci√≥n</h1>

      <div class="test-section">
        <h3>Pruebas Autom√°ticas del Backend</h3>
        <button onclick="runBackendTests()" style="margin-bottom: 10px">
          Ejecutar Pruebas del Backend
        </button>
        <div id="consoleOutput" class="console-output"></div>
      </div>

      <div class="test-section">
        <h3>Prueba Manual del Frontend</h3>
        <div style="display: flex; gap: 20px">
          <div style="flex: 1">
            <h4>Registro de Usuario</h4>
            <form id="testRegisterForm">
              <input
                type="text"
                id="testName"
                placeholder="Nombre"
                value="Usuario Test"
                required
              /><br /><br />
              <input
                type="email"
                id="testEmail"
                placeholder="Email"
                required
              /><br /><br />
              <input
                type="password"
                id="testPassword"
                placeholder="Contrase√±a"
                value="123456"
                required
              /><br /><br />
              <input
                type="password"
                id="testConfirmPassword"
                placeholder="Confirmar contrase√±a"
                value="123456"
                required
              /><br /><br />
              <button type="submit">Registrar Usuario de Prueba</button>
            </form>
            <div id="registerTestResult"></div>
          </div>

          <div style="flex: 1">
            <h4>Login de Usuario</h4>
            <form id="testLoginForm">
              <input
                type="email"
                id="loginEmail"
                placeholder="Email"
                required
              /><br /><br />
              <input
                type="password"
                id="loginPassword"
                placeholder="Contrase√±a"
                value="123456"
                required
              /><br /><br />
              <button type="submit">Login de Prueba</button>
            </form>
            <div id="loginTestResult"></div>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h3>Estado de la Autenticaci√≥n</h3>
        <div id="authStatus"></div>
        <button onclick="checkAuthStatus()">Verificar Estado</button>
        <button onclick="testLogout()">Probar Logout</button>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
      const API_BASE_URL = "http://localhost:3000/api";

      function logToConsole(message) {
        const console = document.getElementById("consoleOutput");
        const timestamp = new Date().toLocaleTimeString();
        console.innerHTML += `[${timestamp}] ${message}\n`;
        console.scrollTop = console.scrollHeight;
      }

      async function runBackendTests() {
        const console = document.getElementById("consoleOutput");
        console.innerHTML = "";

        logToConsole("üöÄ Iniciando pruebas del backend...");

        // Test 1: Conexi√≥n b√°sica
        try {
          logToConsole("üîç Probando conexi√≥n b√°sica...");
          const response = await fetch("http://localhost:3000/");
          const data = await response.json();
          logToConsole("‚úÖ Conexi√≥n b√°sica exitosa");
        } catch (error) {
          logToConsole(`‚ùå Error de conexi√≥n: ${error.message}`);
          return;
        }

        // Test 2: Registro
        const testUser = {
          name: "Usuario Test API",
          email: `api${Date.now()}@test.com`,
          password: "123456",
        };

        try {
          logToConsole("üîç Probando registro...");
          const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testUser),
          });
          const data = await response.json();

          if (data.success) {
            logToConsole(`‚úÖ Registro exitoso: ${testUser.email}`);
            window.testToken = data.data.token;

            // Test 3: Login
            logToConsole("üîç Probando login...");
            const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: testUser.email,
                password: testUser.password,
              }),
            });
            const loginData = await loginResponse.json();

            if (loginData.success) {
              logToConsole("‚úÖ Login exitoso");
              window.testToken = loginData.data.token;

              // Test 4: Perfil
              logToConsole("üîç Probando acceso a perfil...");
              const profileResponse = await fetch(
                `${API_BASE_URL}/auth/profile`,
                {
                  headers: { Authorization: `Bearer ${window.testToken}` },
                }
              );
              const profileData = await profileResponse.json();

              if (profileData.success) {
                logToConsole(
                  `‚úÖ Perfil obtenido: ${profileData.data.user.name}`
                );
                logToConsole("üéâ TODAS LAS PRUEBAS DEL BACKEND EXITOSAS");
              } else {
                logToConsole(
                  `‚ùå Error al obtener perfil: ${profileData.message}`
                );
              }
            } else {
              logToConsole(`‚ùå Error en login: ${loginData.message}`);
            }
          } else {
            logToConsole(`‚ùå Error en registro: ${data.message}`);
          }
        } catch (error) {
          logToConsole(`‚ùå Error en pruebas: ${error.message}`);
        }
      }

      // Test de registro del frontend
      document
        .getElementById("testRegisterForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const resultDiv = document.getElementById("registerTestResult");
          const userData = {
            name: document.getElementById("testName").value,
            email: document.getElementById("testEmail").value,
            password: document.getElementById("testPassword").value,
          };

          // Actualizar email para que sea √∫nico
          userData.email = `test${Date.now()}@example.com`;
          document.getElementById("testEmail").value = userData.email;
          document.getElementById("loginEmail").value = userData.email;

          try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(userData),
            });

            const data = await response.json();

            if (data.success) {
              localStorage.setItem("authToken", data.data.token);
              resultDiv.innerHTML = `<div style="color: green;">‚úÖ Registro exitoso<br>Email: ${userData.email}</div>`;
            } else {
              resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${data.message}</div>`;
            }
          } catch (error) {
            resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
          }
        });

      // Test de login del frontend
      document
        .getElementById("testLoginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const resultDiv = document.getElementById("loginTestResult");
          const loginData = {
            email: document.getElementById("loginEmail").value,
            password: document.getElementById("loginPassword").value,
          };

          try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(loginData),
            });

            const data = await response.json();

            if (data.success) {
              localStorage.setItem("authToken", data.data.token);
              resultDiv.innerHTML = `<div style="color: green;">‚úÖ Login exitoso<br>Usuario: ${data.data.user.name}</div>`;
            } else {
              resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${data.message}</div>`;
            }
          } catch (error) {
            resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
          }
        });

      function checkAuthStatus() {
        const token = localStorage.getItem("authToken");
        const statusDiv = document.getElementById("authStatus");

        if (token) {
          statusDiv.innerHTML = `
                    <div style="color: green;">
                        ‚úÖ Usuario autenticado<br>
                        Token: ${token.substring(0, 20)}...<br>
                        <small>Almacenado en localStorage</small>
                    </div>
                `;
        } else {
          statusDiv.innerHTML = `<div style="color: red;">‚ùå No autenticado</div>`;
        }
      }

      function testLogout() {
        localStorage.removeItem("authToken");
        document.getElementById(
          "authStatus"
        ).innerHTML = `<div style="color: orange;">üîì Sesi√≥n cerrada</div>`;
      }

      // Verificar estado inicial
      document.addEventListener("DOMContentLoaded", () => {
        checkAuthStatus();
      });
    </script>
  </body>
</html>
